import asyncio
from pyrogram import Client, filters
from pyrogram.errors import AuthKeyUnregistered, FloodWait
from datetime import datetime
from zoneinfo import ZoneInfo
from flask import Flask
from threading import Thread

# =======================================================
# Ø¨Ø®Ø´ Û°: ÙˆØ¨ Ø³Ø±ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ø±Ø¨Ø§Øª Ø¯Ø± Repl.it
# =======================================================

# ÛŒÚ© ÙˆØ¨ Ø³Ø±ÙˆØ± Ø³Ø§Ø¯Ù‡ Ø¨Ø§ Flask Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
# Ø§ÛŒÙ† Ø³Ø±ÙˆØ± Ø¨Ø§Ø¹Ø« Ù…ÛŒâ€ŒØ´ÙˆØ¯ Repl.it ÙÚ©Ø± Ú©Ù†Ø¯ Ú©Ù‡ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø´Ù…Ø§ Ù‡Ù…ÛŒØ´Ù‡ ÙØ¹Ø§Ù„ Ø§Ø³Øª
app_flask = Flask('')

@app_flask.route('/')
def home():
    # Ù‡Ø± Ù…ØªÙ†ÛŒ Ø§ÛŒÙ†Ø¬Ø§ Ø¨Ø§Ø´Ø¯ Ú©Ø§ÙÛŒ Ø§Ø³Øª
    return "I am alive!"

def run_flask():
  # Ø³Ø±ÙˆØ± Ø±Ø§ Ø±ÙˆÛŒ Ù‡Ø§Ø³Øª Ùˆ Ù¾ÙˆØ±Øª Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Repl.it Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  app_flask.run(host='0.0.0.0', port=8080)

def keep_alive():
    # Ø³Ø±ÙˆØ± Ø±Ø§ Ø¯Ø± ÛŒÚ© ØªØ±Ø¯ (thread) Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ ØªØ§ Ø¨Ø§ Ø±Ø¨Ø§Øª ØªØ¯Ø§Ø®Ù„ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    t = Thread(target=run_flask)
    t.start()

# =======================================================
# âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Account Configuration)
# =======================================================

# Your credentials
API_ID = 28190856
API_HASH = "6b9b5309c2a211b526c6ddad6eabb521"
PHONE_NUMBER = "+989011243659"
SESSION_NAME = "my_account"

# Ù…ØªÙ† Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØºÛŒØ§Ø¨ Ø´Ù…Ø§ (Ù…ØªÙ† Ø¬Ø¯ÛŒØ¯ Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø´Ù…Ø§)
AUTO_REPLY_MESSAGE = "Ø³Ù„Ø§Ù…ØŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³ØªÙ…. Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† ÙØ±ØµØª Ù¾Ø§Ø³Ø® Ø®ÙˆØ§Ù‡Ù… Ø¯Ø§Ø¯."

# ØªØ¹Ø±ÛŒÙ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØªÙ‡Ø±Ø§Ù†
TEHRAN_TIMEZONE = ZoneInfo("Asia/Tehran")

# Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª Pyrogram
app = Client(SESSION_NAME, api_id=API_ID, api_hash=API_HASH, phone_number=PHONE_NUMBER)

# =======================================================
# Ø¨Ø®Ø´ Û±: Ù…Ø¯ÛŒØ±ÛŒØª ÙÙˆÙ†Øª Ùˆ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ (Live Clock)
# =======================================================

def stylize_time(time_str: str) -> str:
    """
    ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙÙˆÙ†Øª Ø´ÛŒÚ© Sans-Serif Bold.
    Ø§ÛŒÙ† ÙÙˆÙ†Øª Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ Ø·ÙˆØ± Ú©Ø§Ù…Ù„ Ø§Ø² ØªÙ…Ø§Ù… Ø§Ø¹Ø¯Ø§Ø¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.
    """
    conversion_map = {
        '0': 'ğŸ¬', '1': 'ğŸ­', '2': 'ğŸ®', '3': 'ğŸ¯', '4': 'ğŸ°',
        '5': 'ğŸ±', '6': 'ğŸ²', '7': 'ğŸ³', '8': 'ğŸ´', '9': 'ğŸµ',
        ':': ':'
    }
    return ''.join(conversion_map.get(char, char) for char in time_str)

async def update_name():
    """
    Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¨Ø§ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡. Ø¨Ø³ÛŒØ§Ø± Ù…Ù‚Ø§ÙˆÙ… Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ù‚Ø·Ø¹ÛŒ Ø´Ø¨Ú©Ù‡ Ùˆ Ø®Ø·Ø§Ù‡Ø§.
    """
    first_name = "ğ“ğ‘’ ğ’¶ğ“‚ğ’¾ğ“‡"
    
    while True:
        try:
            # --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ---
            tehran_time = datetime.now(TEHRAN_TIMEZONE)
            current_time_str = tehran_time.strftime("%H:%M")
            stylized_time_str = stylize_time(current_time_str)
            name_with_clock = f"{first_name} {stylized_time_str}"
            
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…
            await app.update_profile(first_name=name_with_clock)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âœ… Updated name to: {name_with_clock}")
        
        except FloodWait as e:
            # Ø§Ú¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ú¯ÙˆÛŒØ¯ ØµØ¨Ø± Ú©Ù†
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ğŸ›‘ Rate Limit hit. Waiting for {e.value} seconds.")
            await asyncio.sleep(e.value)
            
        except ConnectionError:
            # Ø®Ø·Ø§ÛŒ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡ (Ø§Ø² exception Ø¯Ø§Ø®Ù„ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âš ï¸ Connection lost. Waiting 10 seconds before next attempt.")
            await asyncio.sleep(10)
            
        except Exception as e:
            # Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âŒ Unhandled Error during name update: {e}")
            await asyncio.sleep(5)

        # --- Ù…Ù†Ø·Ù‚ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ ---
        now = datetime.now()
        # Ù…Ù†ØªØ¸Ø± Ù…ÛŒâ€ŒÙ…Ø§Ù†ÛŒÙ… ØªØ§ Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¨Ø¹Ø¯ÛŒ Ø´Ø±ÙˆØ¹ Ø´ÙˆØ¯
        sleep_seconds = 60 - now.second
        await asyncio.sleep(sleep_seconds)

# =======================================================
# Ø¨Ø®Ø´ Û²: Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± (Auto-Reply)
# =======================================================

@app.on_message(filters.private & ~filters.me)
async def auto_reply(client: Client, message):
    """
    ÙÙ‚Ø· Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ (Private Messages) Ú©Ù‡ Ø§Ø² Ø·Ø±Ù Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
    Ú©Ø¯ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ú©Ø§Ù…Ù„Ø§ Ø¯Ø±Ø³Øª Ø¨ÙˆØ¯ Ùˆ Ù…Ø´Ú©Ù„ÛŒ Ù†Ø¯Ø§Ø´Øª. Ø§Ø­ØªÙ…Ø§Ù„Ø§ Ú†ÙˆÙ† Ø±Ø¨Ø§Øª Ø´Ù…Ø§ Ø®Ø§Ù…ÙˆØ´ Ù…ÛŒâ€ŒØ´Ø¯ØŒ Ú©Ø§Ø± Ù†Ù…ÛŒâ€ŒÚ©Ø±Ø¯.
    """
    try:
        if message.from_user and not message.from_user.is_bot:
            await message.reply_text(AUTO_REPLY_MESSAGE)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ğŸ’¬ SUCCESS: Auto-reply sent to {message.from_user.first_name} ({message.chat.id})")
    except Exception as e:
        print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âŒ ERROR: Failed to send auto-reply to {message.chat.id}: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û³: ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† (Concurrency)
# =======================================================

async def main():
    """Starts the client safely and runs the tasks."""
    # Û±. ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø±ÙˆØ´Ù† Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ø±Ø¨Ø§Øª Ø§Ø¬Ø±Ø§ Ú©Ù†
    keep_alive()
    print("âœ… Keep-alive web server started.")
    print("----------------------------------------------------------------------")
    print(f"Starting Telegram Client for user: {PHONE_NUMBER}")
    
    try:
        # Û². Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªÙ„Ú¯Ø±Ø§Ù…
        await app.start()
    except AuthKeyUnregistered:
        print("ğŸ”´ FATAL ERROR: Authentication Key Unregistered. Please delete the 'my_account.session' file and restart.")
        return
    except Exception as e:
        print(f"ğŸ”´ FATAL ERROR: Unhandled exception during startup: {e}")
        return

    # Û³. Ø§Ø¬Ø±Ø§ÛŒ Ø­Ù„Ù‚Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    asyncio.create_task(update_name())
    print("âœ… Live Clock started as a background task.")
    
    # Û´. Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø±Ø§ÛŒ Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
    print("ğŸ‘‚ Auto-Reply listener is active and waiting for private messages...")
    await asyncio.Event().wait()
    
    await app.stop()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nBot stopped by user (Ctrl+C). Goodbye!")

