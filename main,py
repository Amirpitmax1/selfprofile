import asyncio
import os
from pyrogram import Client, filters
from pyrogram.errors import AuthKeyUnregistered, FloodWait, RPCError
from datetime import datetime
from zoneinfo import ZoneInfo
import logging
from flask import Flask, request, redirect, url_for, render_template_string
import requests # Ø¨Ø±Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø¶Ø¯ Ø®ÙˆØ§Ø¨

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù„Ø§Ú¯ÛŒÙ†Ú¯
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# =======================================================
# âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø­Ø§Ù„Øª (Global State)
# =======================================================

# Your credentials (API ID and Hash are necessary for Pyrogram client initialization)
API_ID = 28190856
API_HASH = "6b9b5309c2a211b526c6ddad6eabb521"
SESSION_NAME = "my_account_web"

# Ù…ØªÙ† Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØºÛŒØ§Ø¨ Ø´Ù…Ø§
AUTO_REPLY_MESSAGE = "Ø³Ù„Ø§Ù…ØŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³ØªÙ…. Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù…. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ…ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† ÙØ±ØµØª Ù…Ù…Ú©Ù†ØŒ Ù¾Ø§Ø³Ø® Ø®ÙˆØ§Ù‡Ù… Ø¯Ø§Ø¯."

# ØªØ¹Ø±ÛŒÙ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØªÙ‡Ø±Ø§Ù†
TEHRAN_TIMEZONE = ZoneInfo("Asia/Tehran")

# Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø­Ø§Ù„Øª Ø³Ø±Ø§Ø³Ø±ÛŒ
app_flask = Flask(__name__)
# Ø§Ø² app_client Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ù†Ù…ÙˆÙ†Ù‡ ÙØ¹Ø§Ù„ Pyrogram Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆØ¯
app_client = None 
bot_running_event = asyncio.Event()

# =======================================================
# Ø¨Ø®Ø´ Û±: Ù…Ø¯ÛŒØ±ÛŒØª ÙÙˆÙ†Øª Ùˆ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ (Live Clock)
# =======================================================

def stylize_time(time_str: str) -> str:
    """ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙÙˆÙ†Øª Ø´ÛŒÚ© Math Monospace."""
    conversion_map = {
        '0': 'ğŸ¶', '1': 'ğŸ·', '2': 'ğŸ¸', '3': 'ğŸ¹', '4': 'ğŸº',
        '5': 'ğŸ»', '6': 'ğŸ¼', '7': 'ğŸ½', '8': 'ğŸ¾', '9': 'ğŸ¿',
        ':': ':'
    }
    return ''.join(conversion_map.get(char, char) for char in time_str)

async def update_name():
    """Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¨Ø§ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡. Ø¨Ø³ÛŒØ§Ø± Ù…Ù‚Ø§ÙˆÙ… Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ù‚Ø·Ø¹ÛŒ Ø´Ø¨Ú©Ù‡ Ùˆ Ø®Ø·Ø§Ù‡Ø§."""
    first_name = "ğ“ğ‘’ ğ’¶ğ“‚ğ’¾ğ“‡"
    
    # Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ú©Ù„Ø§ÛŒÙ†Øª ÙØ¹Ø§Ù„
    global app_client
    if app_client is None:
        logger.error("âŒ update_name called but app_client is not initialized.")
        return

    while True:
        # --- Ù…Ù†Ø·Ù‚ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ (Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø± Ø¯Ø± Ø­Ù„Ù‚Ù‡ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ù‚Øª) ---
        now = datetime.now()
        seconds_into_minute = now.second + now.microsecond / 1_000_000
        sleep_seconds = 60 - seconds_into_minute
        
        if sleep_seconds < 0.5:
            sleep_seconds += 60
        
        await asyncio.sleep(sleep_seconds)
        
        try:
            # --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ---
            tehran_time = datetime.now(TEHRAN_TIMEZONE)
            current_time_str = tehran_time.strftime("%H:%M")
            stylized_time_str = stylize_time(current_time_str)
            name_with_clock = f"{first_name} {stylized_time_str}"
            
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…
            await app_client.update_profile(first_name=name_with_clock)
            logger.info(f"âœ… Live Clock: Updated name to: {name_with_clock}")
        
        except FloodWait as e:
            logger.warning(f"ğŸ›‘ Live Clock: Rate Limit hit. Waiting for {e.value} seconds.")
            await asyncio.sleep(e.value)
            
        except (RPCError, asyncio.TimeoutError):
            logger.error("âš ï¸ Live Clock: Connection error or API call timed out. Waiting 10 seconds before next attempt.")
            await asyncio.sleep(10)
            
        except Exception as e:
            logger.error(f"âŒ Live Clock: Unhandled Error during name update. Attempting to recover: {e}")
            await asyncio.sleep(5)

# =======================================================
# Ø¨Ø®Ø´ Û²: Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± (Auto-Reply)
# =======================================================

# Ø§ÛŒÙ† Ø¯Ú©ÙˆØ±Ø§ØªÙˆØ± Ø¨Ø§ÛŒØ¯ Ø¨Ø¹Ø¯ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ app_client Ø¨Ù‡ Ø¢Ù† Ù…ØªØµÙ„ Ø´ÙˆØ¯.
# Ù…Ø§ Ø§Ø² ÛŒÚ© Ù…ØªØºÛŒØ± Ø¬Ù‡Ø§Ù†ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ….
def register_handlers(client: Client):
    @client.on_message(filters.private & ~filters.me)
    async def auto_reply(client: Client, message):
        """ÙÙ‚Ø· Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ú©Ù‡ Ø§Ø² Ø·Ø±Ù Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
        try:
            if message.from_user and not message.from_user.is_bot:
                await message.reply_text(AUTO_REPLY_MESSAGE)
                logger.info(f"ğŸ’¬ Auto-Reply: SUCCESS sent to {message.from_user.first_name}")
        except Exception as e:
            logger.error(f"âŒ Auto-Reply: Failed to send to {message.chat.id}: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û³: Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø¶Ø¯ Ø®ÙˆØ§Ø¨ (Anti-Sleep for Render)
# =======================================================

async def keep_alive(render_url: str):
    """
    Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ© Ø¨Ø§Ø± Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ URL Ø®ÙˆØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒ ÙØ±Ø³ØªØ¯ ØªØ§ Ø§Ø² Ø®ÙˆØ§Ø¨ÛŒØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†Ø¯.
    """
    logger.info(f"ğŸ”‹ Anti-Sleep activated. Pinging URL: {render_url} every 5 minutes.")
    while True:
        await asyncio.sleep(300) # 5 minutes
        try:
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² requests Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª HTTP
            requests.get(render_url, timeout=10)
            logger.debug("âœ¨ Keep Alive: Ping successful.")
        except Exception as e:
            logger.warning(f"âŒ Keep Alive: Failed to ping URL {render_url}. Error: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û´: Ø±Ø§Ø¨Ø· ÙˆØ¨ (Flask Web Interface)
# =======================================================

# Ù‚Ø§Ù„Ø¨ HTML Ø³Ø§Ø¯Ù‡ Ùˆ Ø²ÛŒØ¨Ø§ Ø¨Ø§ Tailwind CSS Ø¨Ø±Ø§ÛŒ ÙØ±Ù… ÙˆØ±ÙˆØ¯
WEB_FORM_HTML = """
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø³Ù„Ùâ€ŒØ¨Ø§Øª Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border border-blue-200">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">â° ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø±Ø¨Ø§Øª Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡</h1>
        <p class="text-gray-600 text-center mb-8">Ù„Ø·ÙØ§Ù‹ Session String Ù…Ø¹ØªØ¨Ø± Ø®ÙˆØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ ØªØ§ Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø´ÙˆØ¯. Ø§ÛŒÙ† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù‡Ø±Ú¯Ø² Ø°Ø®ÛŒØ±Ù‡ Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
        
        {% if status %}
            <div class="p-4 mb-6 rounded-lg font-medium text-center 
            {% if status == 'ÙØ¹Ø§Ù„ Ø´Ø¯' %} bg-green-100 text-green-700 
            {% elif status == 'Ù…Ù†ØªØ¸Ø±' %} bg-yellow-100 text-yellow-700
            {% else %} bg-red-100 text-red-700 
            {% endif %}">
                ÙˆØ¶Ø¹ÛŒØª: {{ status }}
            </div>
        {% endif %}

        <form method="POST" action="{{ url_for('activate') }}" class="space-y-4">
            <div>
                <label for="session_string" class="block text-sm font-medium text-gray-700">Session String</label>
                <textarea id="session_string" name="session_string" rows="3" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
            
            <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out">
                ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ùˆ Ø´Ø±ÙˆØ¹ Ø±Ø¨Ø§Øª
            </button>
        </form>
        
        <p class="text-xs text-gray-400 text-center mt-6">
            <a href="https://t.me/ye_amir" target="_blank" class="hover:underline">Ù†ÛŒØ§Ø² Ø¨Ù‡ Session String Ø¯Ø§Ø±ÛŒØ¯ØŸ</a>
        </p>
    </div>
</body>
</html>
"""

# Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ ÙˆØ¨â€ŒØ³Ø§ÛŒØª
@app_flask.route('/', methods=['GET'])
def index():
    status = "Ù…Ù†ØªØ¸Ø± ÙˆØ±ÙˆØ¯ Ø³Ø´Ù†"
    if bot_running_event.is_set():
        status = "Ø±Ø¨Ø§Øª ÙØ¹Ø§Ù„ Ø§Ø³Øª Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø³Ø§Ø¹Øª Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯."
    return render_template_string(WEB_FORM_HTML, status=status)

# Ù…Ø³ÛŒØ± ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ (Ù¾Ø³ Ø§Ø² Ø³Ø§Ø¨Ù…ÛŒØª ÙØ±Ù…)
@app_flask.route('/activate', methods=['POST'])
def activate():
    session_string = request.form.get('session_string', '').strip()
    
    if not session_string:
        return render_template_string(WEB_FORM_HTML, status="Ø®Ø·Ø§: Session String Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ø®Ø§Ù„ÛŒ Ø¨Ø§Ø´Ø¯."), 400

    # Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§Ø³ØªØŒ Ø§ÙˆÙ„ Ø¢Ù† Ø±Ø§ Ù…ØªÙˆÙ‚Ù Ú©Ù†
    global app_client
    if app_client is not None and bot_running_event.is_set():
        # Ù…ØªÙˆÙ‚Ù Ú©Ø±Ø¯Ù† Ø³Ø±ÙˆÛŒØ³ Ù‚Ø¨Ù„ÛŒ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ Ø§Ù…Ø§ ØªÙˆØµÛŒÙ‡ Ù…ÛŒ Ø´ÙˆØ¯)
        pass # Ø¯Ø± Ø§ÛŒÙ† Ù…Ø¹Ù…Ø§Ø±ÛŒØŒ Pyrogram Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¯Ø± ÛŒÚ© Thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø³Øª Ùˆ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ ØªÙˆÙ‚Ù Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ù†ÛŒØ³Øª.

    # Ø´Ø±ÙˆØ¹ ÙˆØ¸Ø§ÛŒÙ Ø±Ø¨Ø§Øª Ø¯Ø± ÛŒÚ© Thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡
    # Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Flask Ø§Ø² Threading Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø§Ø² ÛŒÚ© executor Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ ÙˆØ¸Ø§ÛŒÙ asyncio Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒÙ…
    flask_loop = asyncio.get_event_loop()
    flask_loop.create_task(start_bot_tasks(session_string))
    
    return render_template_string(WEB_FORM_HTML, status="ÙØ¹Ø§Ù„ Ø´Ø¯! Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ Ùˆ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡ Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ú©Ø±Ø¯Ù†Ø¯."), 200

# =======================================================
# Ø¨Ø®Ø´ Ûµ: Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø³ØªÙ‡ (Core Execution)
# =======================================================

async def start_bot_tasks(session_string):
    """Ø±Ø¨Ø§Øª Pyrogram Ø±Ø§ Ø¨Ø§ Session String Ø¬Ø¯ÛŒØ¯ Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ùˆ ÙˆØ¸Ø§ÛŒÙ Ø±Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒ Ú©Ù†Ø¯."""
    global app_client
    
    # 1. Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§ÛŒÙ†Øª Ø¨Ø§ Ø³Ø´Ù† Ø§Ø³ØªØ±ÛŒÙ†Ú¯ Ø¬Ø¯ÛŒØ¯
    try:
        app_client = Client(
            name=SESSION_NAME, 
            api_id=API_ID, 
            api_hash=API_HASH, 
            session_string=session_string
        )
        logger.info("Initializing Pyrogram Client...")

        # 2. Ø§ØªØµØ§Ù„
        await app_client.start()
        logger.info("âœ… Client successfully connected and authenticated!")
        
    except AuthKeyUnregistered:
        logger.critical("ğŸ”´ FATAL ERROR: Invalid or expired Session String. Please check your session and try again.")
        app_client = None
        return
    except Exception as e:
        logger.critical(f"ğŸ”´ FATAL ERROR during client start: {e}")
        app_client = None
        return

    # 3. Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    register_handlers(app_client)
    logger.info("âœ… Auto-Reply handler registered.")

    # 4. Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø§Ø¹Øª Ùˆ Ø¶Ø¯ Ø®ÙˆØ§Ø¨
    asyncio.create_task(update_name())
    logger.info("âœ… Live Clock started as a background task.")

    # Anti-Sleep (ÙÙ‚Ø· Ø§Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Render ÛŒØ§ Ù…Ø´Ø§Ø¨Ù‡ Ù‡Ø³ØªÛŒÙ…)
    render_url = os.environ.get('RENDER_EXTERNAL_URL') or "http://127.0.0.1:5000"
    asyncio.create_task(keep_alive(render_url))
    logger.info("âœ… Anti-Sleep task initiated.")

    bot_running_event.set() # ØªÙ†Ø¸ÛŒÙ… ÙÙ„Ú¯ Ø¨Ø±Ø§ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª
    
    # Ø§ÛŒÙ†Ø¬Ø§ Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ await Event().wait() Ù†ÛŒØ³Øª Ú†ÙˆÙ† Flask Ù¾Ø±ÙˆØ³Ù‡ Ø§ØµÙ„ÛŒ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒ Ø¯Ø§Ø±Ø¯.


def run_pyrogram_and_flask():
    """Ø´Ø±ÙˆØ¹ ÙˆØ¸Ø§ÛŒÙ Pyrogram Ùˆ Flask Ø¯Ø± Ø­Ù„Ù‚Ù‡ async ÙˆØ§Ø­Ø¯."""
    # Render Ù¾ÙˆØ±Øª Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ PORT Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒ Ú©Ù†Ø¯
    port = int(os.environ.get("PORT", 5000))
    host = '0.0.0.0' # Ø¨Ø±Ø§ÛŒ Ø±Ù†Ø¯Ø± Ø¶Ø±ÙˆØ±ÛŒ Ø§Ø³Øª
    
    # Ø§Ø² Ø³Ø±ÙˆÛŒØ³ Ù‡Ø§ÛŒ Flask Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø¯Ø± Ø­Ù„Ù‚Ù‡ asyncio Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ….
    # Ø¨Ù‡ Ø¬Ø§ÛŒ app_flask.run() Ú©Ù‡ Ù…Ø³Ø¯ÙˆØ¯ Ú©Ù†Ù†Ø¯Ù‡ Ø§Ø³ØªØŒ Ø§Ø² Ø§Ø¨Ø²Ø§Ø± Ú©Ù…Ú©ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ….
    from waitress import serve
    logger.info(f"ğŸŒ Flask Web Server starting on {host}:{port}")

    # Ø§Ø² Ø¢Ù†Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Pyrogram Ùˆ Flask Ù‡Ø± Ø¯Ùˆ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯ØŒ Ø§Ø² ÛŒÚ© Executor Ø¨Ø±Ø§ÛŒ Flask Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ…
    # Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Flask Ø±Ø§ Ø¯Ø± ÛŒÚ© Thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø¬Ø±Ø§ Ù…ÛŒ Ú©Ù†Ø¯ Ùˆ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒ Ø¯Ù‡Ø¯ asyncio Ú©Ø§Ø± Ú©Ù†Ø¯.
    # ØªÙˆØ¬Ù‡: Ø¯Ø± Ù…Ø­ÛŒØ· Ø±Ù†Ø¯Ø± Ù†ÛŒØ§Ø² Ø¨Ù‡ Waitress ÛŒØ§ Gunicorn Ø¯Ø§Ø±ÛŒØ¯ØŒ Ù…Ø§ Ø§Ø² Waitress Ø¨Ø±Ø§ÛŒ Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ….
    
    # Start the Flask server using a thread pool executor, allowing the asyncio loop to run
    loop = asyncio.get_event_loop()
    loop.run_in_executor(None, serve, app_flask, host=host, port=port)
    
    try:
        loop.run_forever()
    except KeyboardInterrupt:
        logger.info("\nServer and Bot stopped by user (Ctrl+C).")
    finally:
        if app_client:
            loop.run_until_complete(app_client.stop())
        logger.info("Cleanup complete. Goodbye!")

if __name__ == "__main__":
    # Ø§Ú¯Ø± Ø¯Ø± Ù…Ø­ÛŒØ· Ù„ÙˆÚ©Ø§Ù„ Ø§Ø¬Ø±Ø§ Ù…ÛŒ Ú©Ù†ÛŒØ¯ØŒ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø± Ù„Ø§Ú¯ÛŒÙ† Ú©Ù†ÛŒØ¯ (Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø³Ø´Ù† ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯)
    if os.path.exists(f"{SESSION_NAME}.session"):
        logger.info("Session file found. Attempting to start the bot automatically...")
        asyncio.run(start_bot_tasks(None)) # Ø¨Ø§ None Ù…ÛŒ ØªÙˆØ§Ù†Ø¯ Ø³Ø´Ù† Ø±Ø§ Ø§Ø² ÙØ§ÛŒÙ„ Ø¨Ø®ÙˆØ§Ù†Ø¯
        
    # Ø­Ø§Ù„Ø§ Flask Ùˆ Pyrogram Ø±Ø§ Ù‡Ù…Ø²Ù…Ø§Ù† Ø§Ø¬Ø±Ø§ Ú©Ù†
    run_pyrogram_and_flask()
