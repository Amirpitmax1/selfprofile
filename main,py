from pyrogram import Client
import asyncio
from datetime import datetime
from zoneinfo import ZoneInfo
from flask import Flask
from threading import Thread

# â”€â”€â”€ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ú©Ø§Ù†Øª â”€â”€â”€
api_id = 28190856
api_hash = "6b9b5309c2a211b526c6ddad6eabb521"
phone_number = "+989011243659"

# â”€â”€â”€ Ú©Ù„Ø§ÛŒÙ†Øª ØªÙ„Ú¯Ø±Ø§Ù… â”€â”€â”€
app = Client("my_account", api_id=api_id, api_hash=api_hash, phone_number=phone_number)

# â”€â”€â”€ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ Ø§ÛŒØ±Ø§Ù† â”€â”€â”€
TEHRAN_TIMEZONE = ZoneInfo("Asia/Tehran")

# â”€â”€â”€ ÙˆØ¨â€ŒØ³Ø±ÙˆØ± Ø³Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒÙ†Ú¯ â”€â”€â”€
app_flask = Flask('')

@app_flask.route('/')
def home():
    return "Self Bot is running with clock â°"

def run():
    app_flask.run(host='0.0.0.0', port=8080)

def keep_alive():
    t = Thread(target=run)
    t.start()

# â”€â”€â”€ ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… Ø¨Ù‡ ÙÙˆÙ†Øª Ø®Ø§Øµ â”€â”€â”€
def stylize_time(time_str: str) -> str:
    conversion_map = {
        '0': 'ğŸ¶', '1': 'ğŸ·', '2': 'ğŸ¸', '3': 'ğŸ¹', '4': 'ğŸº',
        '5': 'ğŸ»', '6': 'ğŸ¼', '7': 'ğŸ½', '8': 'ğŸ¾', '9': 'ğŸ¿',
        ':': ':'
    }
    return ''.join(conversion_map.get(char, char) for char in time_str)

# â”€â”€â”€ Ø¢Ù¾Ø¯ÛŒØª Ø§Ø³Ù… Ø¨Ø§ Ø³Ø§Ø¹Øª â”€â”€â”€
async def update_name():
    while True:
        tehran_time = datetime.now(TEHRAN_TIMEZONE)
        current_time_str = tehran_time.strftime("%H:%M")
        stylized_time_str = stylize_time(current_time_str)
        name_with_clock = f"ğ“ğ‘’ ğ’¶ğ“‚ğ’¾ğ“‡ {stylized_time_str}"

        try:
            await app.update_profile(first_name=name_with_clock)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] Updated name to: {name_with_clock}")
        except Exception as e:
            print(f"Error updating name: {e}")

        now = datetime.now()
        seconds_into_minute = now.second + now.microsecond / 1_000_000
        sleep_seconds = 60 - seconds_into_minute
        if sleep_seconds < 0.5:
            sleep_seconds += 60
        await asyncio.sleep(sleep_seconds)

# â”€â”€â”€ Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ â”€â”€â”€
async def main():
    print("Starting Telegram Client...")
    await app.start()
    print("Client running. Starting name update loop.")
    await update_name()
    await app.stop()

if __name__ == "__main__":
    keep_alive()  # Ø§ÛŒÙ† Ø®Ø· Ù†Ø°Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø®Ø§Ù…ÙˆØ´ Ø´Ù‡
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\nBot stopped by user.")
    except Exception as e:
        print(f"An unexpected error occurred in main execution: {e}")
