import asyncio
import os
from pyrogram import Client, filters
from pyrogram.errors import AuthKeyUnregistered, FloodWait, RPCError
from datetime import datetime
from zoneinfo import ZoneInfo
import logging
from flask import Flask, request, render_template_string
import requests # Ø¨Ø±Ø§ÛŒ Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø¶Ø¯ Ø®ÙˆØ§Ø¨
from waitress import serve # Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Ø§ÛŒÙ…Ù† Flask Ø¯Ø± Ø³Ø±ÙˆØ±Ù‡Ø§ÛŒ Ø§Ø¨Ø±ÛŒ

# ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ù„Ø§Ú¯ÛŒÙ†Ú¯
logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
logger = logging.getLogger(__name__)

# =======================================================
# âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø­Ø§Ù„Øª (Global State)
# =======================================================

# ØªÙˆØµÛŒÙ‡ Ù…ÛŒ Ø´ÙˆØ¯ Ø§ÛŒÙ† Ù…Ù‚Ø§Ø¯ÛŒØ± Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Secrets Ø¯Ø± Replit/Render ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯.
API_ID = int(os.environ.get("API_ID", 28190856))
API_HASH = os.environ.get("API_HASH", "6b9b5309c2a211b526c6ddad6eabb521")
SESSION_NAME = "my_account_web"

# NEW: Ø§Ø² Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ùˆ Ù¾Ø³ÙˆØ±Ø¯ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ) Ø¯Ø± Secrets Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.
# Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† Ø´Ù…Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø¯Ø± Ú©Ø¯ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯.
PHONE_NUMBER = os.environ.get("PHONE_NUMBER", "+989011243659")
# Ø±Ù…Ø² Ø¯ÙˆÙ…Ø±Ø­Ù„Ù‡â€ŒØ§ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù…Ø³ØªÙ‚ÛŒÙ… Ø¯Ø± Ú©Ø¯ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯. (ØªÙˆØµÛŒÙ‡: Ø¨Ø±Ø§ÛŒ Ø§Ù…Ù†ÛŒØª Ø¨ÛŒØ´ØªØ±ØŒ Ø¢Ù† Ø±Ø§ Ø¯Ø± Secrets Ø¨Ú¯Ø°Ø§Ø±ÛŒØ¯)
BOT_PASSWORD = os.environ.get("BOT_PASSWORD", "Amirpitmax$1388$")


# Ù…ØªÙ† Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØºÛŒØ§Ø¨ Ø´Ù…Ø§
AUTO_REPLY_MESSAGE = "Ø³Ù„Ø§Ù…ØŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³ØªÙ…. Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù…. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ…ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† ÙØ±ØµØª Ù…Ù…Ú©Ù†ØŒ Ù¾Ø§Ø³Ø® Ø®ÙˆØ§Ù‡Ù… Ø¯Ø§Ø¯."

# ØªØ¹Ø±ÛŒÙ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØªÙ‡Ø±Ø§Ù†
TEHRAN_TIMEZONE = ZoneInfo("Asia/Tehran")

# Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø­Ø§Ù„Øª Ø³Ø±Ø§Ø³Ø±ÛŒ
app_flask = Flask(__name__)
app_client = None 
bot_running_event = asyncio.Event()

# =======================================================
# Ø¨Ø®Ø´ Û±: Ù…Ø¯ÛŒØ±ÛŒØª ÙÙˆÙ†Øª Ùˆ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ (Live Clock)
# =======================================================

def stylize_time(time_str: str) -> str:
    """
    ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙÙˆÙ†Øª Ø´ÛŒÚ© Fullwidth (ØªÙ…Ø§Ù… Ø¹Ø±Ø¶) Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ± Ø¨Ø§ Ø¯Ø³ØªÚ¯Ø§Ù‡â€ŒÙ‡Ø§.
    """
    conversion_map = {
        '0': 'ï¼', '1': 'ï¼‘', '2': 'ï¼’', '3': 'ï¼“', '4': 'ï¼”',
        '5': 'ï¼•', '6': 'ï¼–', '7': 'ï¼—', '8': 'ï¼˜', '9': 'ï¼™',
        ':': 'ï¼š' # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©ÙˆÙ„ÙˆÙ† ØªÙ…Ø§Ù… Ø¹Ø±Ø¶ Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ
    }
    return ''.join(conversion_map.get(char, char) for char in time_str)

async def update_name():
    """Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¨Ø§ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡. Ø¨Ø³ÛŒØ§Ø± Ù…Ù‚Ø§ÙˆÙ… Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ù‚Ø·Ø¹ÛŒ Ø´Ø¨Ú©Ù‡ Ùˆ Ø®Ø·Ø§Ù‡Ø§."""
    first_name = "ğ“ğ‘’ ğ’¶ğ“‚ğ’¾ğ“‡"
    
    global app_client
    if app_client is None:
        logger.error("âŒ update_name called but app_client is not initialized.")
        return

    while True:
        # --- Ù…Ù†Ø·Ù‚ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ (Ø§ÙˆÙ„ÛŒÙ† Ú©Ø§Ø± Ø¯Ø± Ø­Ù„Ù‚Ù‡ØŒ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø§Ø² Ø¯Ù‚Øª) ---
        now = datetime.now()
        seconds_into_minute = now.second + now.microsecond / 1_000_000
        sleep_seconds = 60 - seconds_into_minute
        
        if sleep_seconds < 0.5:
            sleep_seconds += 60
        
        await asyncio.sleep(sleep_seconds)
        
        try:
            # --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ---
            tehran_time = datetime.now(TEHRAN_TIMEZONE)
            current_time_str = tehran_time.strftime("%H:%M")
            stylized_time_str = stylize_time(current_time_str)
            name_with_clock = f"{first_name} {stylized_time_str}"
            
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…
            await app_client.update_profile(first_name=name_with_clock)
            logger.info(f"âœ… Live Clock: Updated name to: {name_with_clock}")
        
        except FloodWait as e:
            logger.warning(f"ğŸ›‘ Live Clock: Rate Limit hit. Waiting for {e.value} seconds.")
            await asyncio.sleep(e.value)
            
        except (RPCError, asyncio.TimeoutError):
            logger.error("âš ï¸ Live Clock: Connection error or API call timed out. Waiting 10 seconds before next attempt.")
            await asyncio.sleep(10)
            
        except Exception as e:
            logger.error(f"âŒ Live Clock: Unhandled Error during name update. Attempting to recover: {e}")
            await asyncio.sleep(5)

# =======================================================
# Ø¨Ø®Ø´ Û²: Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± (Auto-Reply)
# =======================================================

def register_handlers(client: Client):
    @client.on_message(filters.private & ~filters.me)
    async def auto_reply(client: Client, message):
        """ÙÙ‚Ø· Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ Ú©Ù‡ Ø§Ø² Ø·Ø±Ù Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯."""
        try:
            if message.from_user and not message.from_user.is_bot:
                await message.reply_text(AUTO_REPLY_MESSAGE)
                logger.info(f"ğŸ’¬ Auto-Reply: SUCCESS sent to {message.from_user.first_name}")
        except Exception as e:
            logger.error(f"âŒ Auto-Reply: Failed to send to {message.chat.id}: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û³: Ù…Ú©Ø§Ù†ÛŒØ²Ù… Ø¶Ø¯ Ø®ÙˆØ§Ø¨ (Anti-Sleep for Render/Replit)
# =======================================================

async def keep_alive(anti_sleep_url: str):
    """
    Ù‡Ø± 5 Ø¯Ù‚ÛŒÙ‚Ù‡ ÛŒÚ© Ø¨Ø§Ø± Ø¨Ù‡ Ø¢Ø¯Ø±Ø³ URL Ø®ÙˆØ¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù…ÛŒ ÙØ±Ø³ØªØ¯ ØªØ§ Ø§Ø² Ø®ÙˆØ§Ø¨ÛŒØ¯Ù† Ø³Ø±ÙˆØ± Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ú©Ù†Ø¯.
    """
    if anti_sleep_url == "http://127.0.0.1:5000":
        logger.warning("âŒ ANTI-SLEEP WARNING: The URL is set to localhost. You MUST set the 'RENDER_EXTERNAL_URL' Secret in Replit with your public URL (e.g., https://selfprofile-3.amirpitmax3.repl.co) for 24/7 function.")
    else:
        logger.info(f"ğŸ”‹ Anti-Sleep activated. Pinging URL: {anti_sleep_url} every 5 minutes.")

    while True:
        await asyncio.sleep(300) # 5 minutes
        try:
            if anti_sleep_url != "http://127.0.0.1:5000":
                # Ø§Ø² ÛŒÚ© timeout Ú©ÙˆØªØ§Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ… ØªØ§ Ù…Ù†ØªØ¸Ø± Ù¾Ø§Ø³Ø® Ú©Ø§Ù…Ù„ Ù†Ù…Ø§Ù†ÛŒÙ…
                requests.get(anti_sleep_url, timeout=10)
                logger.debug("âœ¨ Keep Alive: Ping successful.")
        except Exception as e:
            logger.warning(f"âŒ Keep Alive: Failed to ping URL {anti_sleep_url}. Error: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û´: Ø±Ø§Ø¨Ø· ÙˆØ¨ (Flask Web Interface)
# =======================================================

# Ù‚Ø§Ù„Ø¨ HTML Ø³Ø§Ø¯Ù‡ Ùˆ Ø²ÛŒØ¨Ø§ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ÙˆØ¶Ø¹ÛŒØª Ùˆ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†
WEB_FORM_HTML = """
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÙˆØ¶Ø¹ÛŒØª Ø³Ù„Ùâ€ŒØ¨Ø§Øª Clock</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
        body { font-family: 'Vazirmatn', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-2xl border border-blue-200">
        <h1 class="text-3xl font-bold text-center text-blue-700 mb-6">â° ÙˆØ¶Ø¹ÛŒØª Ø±Ø¨Ø§Øª Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡</h1>
        <p class="text-gray-600 text-center mb-4">Ø§ÛŒÙ† ØµÙØ­Ù‡ Ø¨Ø±Ø§ÛŒ ÙØ¹Ø§Ù„ Ù†Ú¯Ù‡ Ø¯Ø§Ø´ØªÙ† Ø±Ø¨Ø§Øª Ø¯Ø± Replit Ù„Ø§Ø²Ù… Ø§Ø³Øª.</p>
        
        {% if status %}
            <div class="p-4 mb-6 rounded-lg font-medium text-center 
            {% if 'ÙØ¹Ø§Ù„ Ø´Ø¯' in status %} bg-green-100 text-green-700 
            {% elif 'Ù…Ù†ØªØ¸Ø±' in status %} bg-yellow-100 text-yellow-700
            {% else %} bg-red-100 text-red-700 
            {% endif %}">
                ÙˆØ¶Ø¹ÛŒØª: {{ status }}
            </div>
        {% endif %}

        <div class="text-sm p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
            <h2 class="font-bold text-yellow-800 mb-2">Ù†Ø­ÙˆÙ‡ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†:</h2>
            <ol class="list-decimal list-inside text-yellow-700 space-y-1">
                <li>Ø±Ø¨Ø§Øª Ø±Ø§ Ø¯Ø± Replit **Ø§Ø¬Ø±Ø§ (Run)** Ú©Ù†ÛŒØ¯.</li>
                <li>Ø¯Ø± **Ú©Ù†Ø³ÙˆÙ„ (Console)** Ø±ÛŒÙ¾Ù„ÛŒØªØŒ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ† (Ø¨Ø§ Ú©Ø¯ Ú©Ø´ÙˆØ±) Ùˆ Ø³Ù¾Ø³ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ ØªÙ„Ú¯Ø±Ø§Ù… Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.</li>
                <li>Ù¾Ø³ Ø§Ø² ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚ÛŒØªâ€ŒØ¢Ù…ÛŒØ²ØŒ ÙØ§ÛŒÙ„ Ø³Ø´Ù† Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø±Ø¨Ø§Øª Ø´Ø±ÙˆØ¹ Ø¨Ù‡ Ú©Ø§Ø± Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</li>
            </ol>
            <p class="mt-3 font-semibold text-yellow-800">âš ï¸ Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Û²Û´ Ø³Ø§Ø¹ØªÙ‡ØŒ Session String Ø¨Ù‡ Ù…Ø­ÛŒØ· ÙˆØ¨Ø³Ø§ÛŒØª Ù†ÛŒØ§Ø² Ù†ÛŒØ³ØªØŒ Ø§Ù…Ø§ Ø­ØªÙ…Ø§Ù‹ Ù…ØªØºÛŒØ± `RENDER_EXTERNAL_URL` Ø±Ø§ Ø¯Ø± Secrets Ø±ÛŒÙ¾Ù„ÛŒØª Ø¨Ø§ Ø¢Ø¯Ø±Ø³ Ø¹Ù…ÙˆÙ…ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ù¾Ø± Ú©Ù†ÛŒØ¯.</p>
        </div>
        
        <p class="text-xs text-gray-400 text-center mt-6">
            <a href="https://replit.com/@amirpitmax3/selfprofile-3" target="_blank" class="hover:underline">Ù¾Ø±ÙˆÚ˜Ù‡ Replit Ø´Ù…Ø§</a>
        </p>
    </div>
</body>
</html>
"""

# Ù…Ø³ÛŒØ± Ø§ØµÙ„ÛŒ ÙˆØ¨â€ŒØ³Ø§ÛŒØª
@app_flask.route('/', methods=['GET'])
def index():
    status = "Ø±Ø¨Ø§Øª Ù‡Ù†ÙˆØ² Ø´Ø±ÙˆØ¹ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª (Ú†Ú© Ú©Ø±Ø¯Ù† Ú©Ù†Ø³ÙˆÙ„ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†)."
    if bot_running_event.is_set():
        status = "ÙØ¹Ø§Ù„ Ø´Ø¯! Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ Ùˆ Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ Ù‡Ø³ØªÙ†Ø¯. (Ù„Ø§Ú¯ÛŒÙ† Ù…ÙˆÙÙ‚)"
    elif app_client and not bot_running_event.is_set():
        status = "Ù…Ù†ØªØ¸Ø±... Ø¯Ø± Ø­Ø§Ù„ ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„/Ù„Ø§Ú¯ÛŒÙ† Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„."
        
    return render_template_string(WEB_FORM_HTML, status=status)

# =======================================================
# Ø¨Ø®Ø´ Ûµ: Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ø³ØªÙ‡ (Core Execution)
# =======================================================

async def start_pyrogram_client():
    """
    Ø±Ø¨Ø§Øª Pyrogram Ø±Ø§ Ø´Ø±ÙˆØ¹ Ù…ÛŒ Ú©Ù†Ø¯. Ø§Ú¯Ø± ÙØ§ÛŒÙ„ Ø³Ø´Ù† ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯ØŒ Ø¨Ù‡ Ø·ÙˆØ± Ø®ÙˆØ¯Ú©Ø§Ø±
    Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ù…Ù†ØªØ¸Ø± ÙˆØ±ÙˆØ¯ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†ØŒ Ú©Ø¯ ØªØ§ÛŒÛŒØ¯ Ùˆ Ù¾Ø³ÙˆØ±Ø¯ (Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ 2FA) Ù…ÛŒ Ù…Ø§Ù†Ø¯.
    """
    global app_client
    
    # 1. Ù…Ù‚Ø¯Ø§Ø±Ø¯Ù‡ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ú©Ù„Ø§ÛŒÙ†Øª
    try:
        app_client = Client(
            name=SESSION_NAME, 
            api_id=API_ID, 
            api_hash=API_HASH,
            # Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø§Ø±Ø§Ù…ØªØ±Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ† Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†
            phone_number=PHONE_NUMBER,
            password=BOT_PASSWORD,
            in_memory=False # Ù…Ø·Ù…Ø¦Ù† Ù…ÛŒ Ø´ÙˆÛŒÙ… Ú©Ù‡ Ø³Ø´Ù† Ø¯Ø± ÙØ§ÛŒÙ„ Ø°Ø®ÛŒØ±Ù‡ Ø´ÙˆØ¯
        )
        logger.info("Initializing Pyrogram Client...")

        # 2. Ø§ØªØµØ§Ù„ Ùˆ Ù„Ø§Ú¯ÛŒÙ† (Ø¯Ø± ØµÙˆØ±Øª Ù†ÛŒØ§Ø² Ø¨Ù‡ ØµÙˆØ±Øª ØªØ¹Ø§Ù…Ù„ÛŒ Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„)
        logger.info(f"Connecting to Telegram with phone number: {PHONE_NUMBER}. If the session file is missing, Pyrogram will prompt for OTP and Password in the Replit Console.")
        await app_client.start()
        logger.info("âœ… Client successfully connected and authenticated! Session file saved.")
        
    except AuthKeyUnregistered:
        logger.critical("ğŸ”´ FATAL ERROR: Invalid credentials or session. Please check PHONE_NUMBER and BOT_PASSWORD.")
        app_client = None
        return
    except Exception as e:
        # Ø§ÛŒÙ† Ø®Ø·Ø§ Ø´Ø§Ù…Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ØªØ¹Ø§Ù…Ù„ÛŒ Pyrogram Ø¨Ø±Ø§ÛŒ OTP/Password Ø¯Ø± Ú©Ù†Ø³ÙˆÙ„ Ø®ÙˆØ§Ù‡Ø¯ Ø¨ÙˆØ¯
        logger.critical(f"ğŸ”´ FATAL ERROR during client start (Please check Replit Console for interactive login prompts): {e}")
        app_client = None
        return

    # 3. Ø«Ø¨Øª Ù‡Ù†Ø¯Ù„Ø±Ù‡Ø§
    register_handlers(app_client)
    logger.info("âœ… Auto-Reply handler registered.")

    # 4. Ø§Ø¬Ø±Ø§ÛŒ Ø³Ø§Ø¹Øª Ùˆ Ø¶Ø¯ Ø®ÙˆØ§Ø¨
    asyncio.create_task(update_name())
    logger.info("âœ… Live Clock started as a background task.")

    # Anti-Sleep: Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…ØªØºÛŒØ± Ù…Ø­ÛŒØ·ÛŒ Ú©Ù‡ Ø¢Ø¯Ø±Ø³ Ø¹Ù…ÙˆÙ…ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±Ø¯.
    anti_sleep_url = os.environ.get('RENDER_EXTERNAL_URL') or "http://127.0.0.1:5000"
    asyncio.create_task(keep_alive(anti_sleep_url))

    bot_running_event.set() # ØªÙ†Ø¸ÛŒÙ… ÙÙ„Ú¯ Ø¨Ø±Ø§ÛŒ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù† Ø§Ø¬Ø±Ø§ÛŒ Ø±Ø¨Ø§Øª


def run_pyrogram_and_flask():
    """Ø´Ø±ÙˆØ¹ ÙˆØ¸Ø§ÛŒÙ Pyrogram Ùˆ Flask Ø¯Ø± Ø­Ù„Ù‚Ù‡ async ÙˆØ§Ø­Ø¯."""
    port = int(os.environ.get("PORT", 5000))
    host = '0.0.0.0' 
    
    # Pyrogram client must be started first to allow interactive login in the console
    loop = asyncio.get_event_loop()
    loop.run_until_complete(start_pyrogram_client())
    
    # Only start the web server if Pyrogram client successfully started
    if app_client:
        logger.info(f"ğŸŒ Flask Web Server starting on {host}:{port}")
        # Ø§Ø² ØªØ§Ø¨Ø¹ serve Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Waitress Ø¨Ø±Ø§ÛŒ Ø§Ø¬Ø±Ø§ÛŒ Flask Ø¯Ø± ÛŒÚ© Thread Ø¬Ø¯Ø§Ú¯Ø§Ù†Ù‡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ú©Ù†ÛŒÙ…
        loop.run_in_executor(None, serve, app_flask, host=host, port=port)
    else:
         logger.critical("Web server not started because Pyrogram client failed to initialize or connect.")
        
    try:
        loop.run_forever()
    except KeyboardInterrupt:
        logger.info("\nServer and Bot stopped by user (Ctrl+C).")
    finally:
        # Ú©Ù„Ø§ÛŒÙ†Øª ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª ÙˆØ¬ÙˆØ¯ Ùˆ ÙØ¹Ø§Ù„ Ø¨ÙˆØ¯Ù† Ù…ØªÙˆÙ‚Ù Ù…ÛŒ Ø´ÙˆØ¯
        if app_client:
            loop.run_until_complete(app_client.stop())
        logger.info("Cleanup complete. Goodbye!")

if __name__ == "__main__":
    # Ø§Ø¬Ø±Ø§ÛŒ Pyrogram (Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ÛŒÙ†) Ùˆ Flask (Ø¨Ø±Ø§ÛŒ Keep-Alive)
    run_pyrogram_and_flask()
