import asyncio
from pyrogram import Client, filters
from pyrogram.errors import AuthKeyUnregistered, FloodWait # ConnectionError Ø­Ø°Ù Ø´Ø¯
from datetime import datetime
from zoneinfo import ZoneInfo

# =======================================================
# âš ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ (Account Configuration)
# =======================================================

# Your credentials
API_ID = 28190856
API_HASH = "6b9b5309c2a211b526c6ddad6eabb521"
PHONE_NUMBER = "+989011243659"
SESSION_NAME = "my_account" 

# Ù…ØªÙ† Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± Ø¯Ø± ØºÛŒØ§Ø¨ Ø´Ù…Ø§
AUTO_REPLY_MESSAGE = "Ø³Ù„Ø§Ù…ØŒ Ø¢Ù†Ù„Ø§ÛŒÙ† Ù†ÛŒØ³ØªÙ…. Ù¾ÛŒØ§Ù… Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ø±Ø¯Ù…. Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø®Ø§Ø±Ø¬ Ø§Ø² Ø¯Ø³ØªØ±Ø³ Ù‡Ø³ØªÙ…ØŒ Ø§Ù…Ø§ Ø¯Ø± Ø§ÙˆÙ„ÛŒÙ† ÙØ±ØµØª Ù…Ù…Ú©Ù†ØŒ Ù¾Ø§Ø³Ø® Ø®ÙˆØ§Ù‡Ù… Ø¯Ø§Ø¯."

# ØªØ¹Ø±ÛŒÙ Ù…Ù†Ø·Ù‚Ù‡ Ø²Ù…Ø§Ù†ÛŒ ØªÙ‡Ø±Ø§Ù†
TEHRAN_TIMEZONE = ZoneInfo("Asia/Tehran")

# Ø³Ø§Ø®Øª Ú©Ù„Ø§ÛŒÙ†Øª Pyrogram
app = Client(SESSION_NAME, api_id=API_ID, api_hash=API_HASH, phone_number=PHONE_NUMBER)

# =======================================================
# Ø¨Ø®Ø´ Û±: Ù…Ø¯ÛŒØ±ÛŒØª ÙÙˆÙ†Øª Ùˆ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡ (Live Clock)
# =======================================================

def stylize_time(time_str: str) -> str:
    """
    ØªØ¨Ø¯ÛŒÙ„ Ø§Ø±Ù‚Ø§Ù… Ø³Ø§Ø¹Øª Ø¨Ù‡ ÙÙˆÙ†Øª Ø´ÛŒÚ© Math Monospace.
    """
    conversion_map = {
        '0': 'ğŸ¶', '1': 'ğŸ·', '2': 'ğŸ¸', '3': 'ğŸ¹', '4': 'ğŸº',
        '5': 'ğŸ»', '6': 'ğ¼¼', '7': 'ğŸ½', '8': 'ğŸ¾', '9': 'ğŸ¿',
        ':': ':'
    }
    return ''.join(conversion_map.get(char, char) for char in time_str)

async def update_name():
    """
    Ø­Ù„Ù‚Ù‡ Ø¨ÛŒâ€ŒÙ¾Ø§ÛŒØ§Ù† Ø¨Ø±Ø§ÛŒ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¨Ø§ Ø³Ø§Ø¹Øª Ø²Ù†Ø¯Ù‡. Ø¨Ø³ÛŒØ§Ø± Ù…Ù‚Ø§ÙˆÙ… Ø¯Ø± Ø¨Ø±Ø§Ø¨Ø± Ù‚Ø·Ø¹ÛŒ Ø´Ø¨Ú©Ù‡ Ùˆ Ø®Ø·Ø§Ù‡Ø§.
    """
    first_name = "ğ“ğ‘’ ğ’¶ğ“‚ğ’¾ğ“‡"
    
    while True:
        try:
            # --- Ù…Ù†Ø·Ù‚ Ø§ØµÙ„ÛŒ ---
            tehran_time = datetime.now(TEHRAN_TIMEZONE)
            current_time_str = tehran_time.strftime("%H:%M")
            stylized_time_str = stylize_time(current_time_str)
            name_with_clock = f"{first_name} {stylized_time_str}"
            
            # Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù…
            await app.update_profile(first_name=name_with_clock)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âœ… Updated name to: {name_with_clock}")
        
        except FloodWait as e:
            # Ø§Ú¯Ø± ØªÙ„Ú¯Ø±Ø§Ù… Ø¨Ú¯ÙˆÛŒØ¯ ØµØ¨Ø± Ú©Ù†
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ğŸ›‘ Rate Limit hit. Waiting for {e.value} seconds.")
            await asyncio.sleep(e.value)
            
        except ConnectionError:
            # Ø®Ø·Ø§ÛŒ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡ (Ø§Ø² exception Ø¯Ø§Ø®Ù„ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âš ï¸ Connection lost. Waiting 10 seconds before next attempt.")
            # Pyrogram Ø¨Ù‡ ØµÙˆØ±Øª Ø¯Ø§Ø®Ù„ÛŒ Ø³Ø¹ÛŒ Ø¯Ø± Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ù…ÛŒ Ú©Ù†Ø¯ØŒ Ù…Ø§ ÙÙ‚Ø· Ù…Ú©Ø« Ù…ÛŒ Ú©Ù†ÛŒÙ….
            await asyncio.sleep(10)
            
        except Exception as e:
            # Ù…Ø¯ÛŒØ±ÛŒØª Ø®Ø·Ø§ÛŒ Ø¹Ù…ÙˆÙ…ÛŒ (Ù…Ø«Ù„ Peer ID invalid ÛŒØ§ Ù‡Ø± Ú†ÛŒØ² Ù†Ø§Ø´Ù†Ø§Ø®ØªÙ‡ Ø¯ÛŒÚ¯Ø±)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âŒ Unhandled Error during name update. Attempting to recover: {e}")
            # Ù…Ú©Ø« 5 Ø«Ø§Ù†ÛŒÙ‡ Ø§ÛŒ Ùˆ Ø§Ø¯Ø§Ù…Ù‡ Ø­Ù„Ù‚Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙ„Ø§Ø´ Ù…Ø¬Ø¯Ø¯
            await asyncio.sleep(5) 

        # --- Ù…Ù†Ø·Ù‚ Ù‡Ù…Ú¯Ø§Ù…â€ŒØ³Ø§Ø²ÛŒ (Ø­ØªÛŒ Ø¯Ø± ØµÙˆØ±Øª Ø®Ø·Ø§ Ø§ÛŒÙ† Ø¨Ø®Ø´ Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯) ---
        now = datetime.now()
        seconds_into_minute = now.second + now.microsecond / 1_000_000
        sleep_seconds = 60 - seconds_into_minute
        
        if sleep_seconds < 0.5:
             sleep_seconds += 60

        await asyncio.sleep(sleep_seconds)

# =======================================================
# Ø¨Ø®Ø´ Û²: Ù¾Ø§Ø³Ø® Ø®ÙˆØ¯Ú©Ø§Ø± (Auto-Reply)
# =======================================================

@app.on_message(filters.private & ~filters.me)
async def auto_reply(client: Client, message):
    """
    ÙÙ‚Ø· Ø¨Ù‡ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø®ØµÙˆØµÛŒ (Private Messages) Ú©Ù‡ Ø§Ø² Ø·Ø±Ù Ø®ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ù†ÛŒØ³ØªÙ†Ø¯ØŒ Ù¾Ø§Ø³Ø® Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
    """
    try:
        if message.from_user and not message.from_user.is_bot:
            await message.reply_text(AUTO_REPLY_MESSAGE)
            print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] ğŸ’¬ SUCCESS: Auto-reply sent to {message.from_user.first_name} ({message.chat.id})")
    except Exception as e:
        print(f"[{datetime.now().strftime('%Y-%m-%d %H:%M:%S')}] âŒ ERROR: Failed to send auto-reply to {message.chat.id}: {e}")

# =======================================================
# Ø¨Ø®Ø´ Û³: ØªØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ Ùˆ Ø§Ø¬Ø±Ø§ÛŒ Ù‡Ù…Ø²Ù…Ø§Ù† (Concurrency)
# =======================================================

async def main():
    """Starts the client safely and runs the tasks."""
    print("----------------------------------------------------------------------")
    print(f"Starting Telegram Client for user: {PHONE_NUMBER}")
    
    try:
        # Ø§ØªØµØ§Ù„ Ø§ÙˆÙ„ÛŒÙ‡
        await app.start()
    except AuthKeyUnregistered:
        print("ğŸ”´ FATAL ERROR: Authentication Key Unregistered. Please delete the 'my_account.session' file and restart the bot to re-authenticate.")
        return
    except ConnectionError:
        # Ø®Ø·Ø§ÛŒ Ø§ØªØµØ§Ù„: Ø¯Ø± Ø§ÛŒÙ† Ø¨Ù„ÙˆÚ© Ø§Ø² ConnectionError Ø¯Ø§Ø®Ù„ÛŒ Ù¾Ø§ÛŒØªÙˆÙ† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒ Ø´ÙˆØ¯
        print("ğŸ”´ FATAL ERROR: Initial connection failed. Check your internet connection and Telegram API settings.")
        return
    except Exception as e:
        print(f"ğŸ”´ FATAL ERROR: Unhandled exception during startup: {e}")
        return

    # 2. Ø§Ø¬Ø±Ø§ÛŒ Ø­Ù„Ù‚Ù‡ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù†Ø§Ù… Ø¯Ø± Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡
    asyncio.create_task(update_name())
    print("âœ… Live Clock started as a background task.")
    
    # 3. Ù†Ú¯Ù‡â€ŒØ¯Ø§Ø´ØªÙ† Ø¨Ø±Ù†Ø§Ù…Ù‡
    print("ğŸ‘‚ Auto-Reply listener is active and waiting for private messages...")
    await asyncio.Event().wait()
    
    await app.stop()

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        print("\n\nBot stopped by user (Ctrl+C). Goodbye!")
    except Exception as e:
        print(f"\n\nAn unexpected error occurred in main execution: {e}")
